name: News Pipeline for Vercel

on:
  # Manual trigger with scheduling options - User controlled only
  workflow_dispatch:
    inputs:
      userId:
        description: 'User ID'
        required: true
        type: string
      userName:
        description: 'User Name'
        required: true
        type: string
      email:
        description: 'User Email'
        required: true
        type: string
      language:
        description: 'Preferred Language'
        required: true
        type: choice
        options:
          - 'English'
          - 'Hindi'
        default: 'English'
      newsType:
        description: 'News Category'
        required: true
        type: choice
        options:
          - 'all'
          - 'technology'
          - 'business'
          - 'sports'
          - 'state'
        default: 'all'
      state:
        description: 'State (for state news)'
        required: false
        type: string
      location:
        description: 'Weather Location'
        required: false
        type: string
      scheduleTime:
        description: 'Schedule Time (HH:MM)'
        required: false
        type: string
      timezone:
        description: 'Timezone'
        required: false
        type: string
        default: 'UTC'

  # Cron schedules for common times (temporarily disabled)
  # schedule:
  #   - cron: '0 6 * * *'   # 6 AM UTC daily
  #   - cron: '0 12 * * *'  # 12 PM UTC daily
  #   - cron: '0 18 * * *'  # 6 PM UTC daily

jobs:
  trigger-pipeline:
    runs-on: ubuntu-latest
    
    steps:
      - name: Wait for scheduled time (if specified)
        if: github.event.inputs.scheduleTime != ''
        run: |
          SCHEDULE_TIME="${{ github.event.inputs.scheduleTime }}"
          TIMEZONE="${{ github.event.inputs.timezone || 'UTC' }}"
          
          echo "‚è∞ Scheduled for: $SCHEDULE_TIME ($TIMEZONE)"
          echo "üïê Current time: $(date)"
          
          # Add a 5-second delay for demo
          sleep 5

      - name: Call Vercel API
        run: |
          echo "üöÄ Triggering news pipeline on Vercel..."
          
          # Debug: Check if VERCEL_APP_URL is set
          if [ -z "${{ secrets.VERCEL_APP_URL }}" ]; then
            echo "‚ùå ERROR: VERCEL_APP_URL secret is not set!"
            echo "Please add your Vercel deployment URL to GitHub Secrets"
            echo "Example: https://your-app-name.vercel.app"
            exit 1
          fi
          
          # Construct the API URL
          API_URL="${{ secrets.VERCEL_APP_URL }}/api/run-pipeline"
          echo "üîó API URL: $API_URL"
          
          # Test if the URL is reachable first
          echo "üß™ Testing API endpoint availability..."
          curl_test=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$API_URL" || echo "FAILED")
          
          if [ "$curl_test" = "FAILED" ]; then
            echo "‚ùå ERROR: Cannot reach the API endpoint"
            echo "Please check your VERCEL_APP_URL secret and ensure your app is deployed"
            exit 3
          fi
          
          echo "üì° Endpoint test response: $curl_test"
          
          # Make the actual API call
          echo "üì® Sending pipeline request..."
          response=$(curl -s -w "%{http_code}" --max-time 30 -X POST "$API_URL" \
            -H "Content-Type: application/json" \
            -d '{
              "userId": "${{ github.event.inputs.userId || 'github-scheduled' }}",
              "userName": "${{ github.event.inputs.userName || 'Scheduled User' }}",
              "email": "${{ github.event.inputs.email || 'test@example.com' }}",
              "language": "${{ github.event.inputs.language || 'English' }}",
              "newsType": "${{ github.event.inputs.newsType || 'all' }}",
              "state": "${{ github.event.inputs.state }}",
              "location": "${{ github.event.inputs.location }}",
              "source": "github-workflow-vercel"
            }' || echo "CURL_FAILED")
          
          # Check if curl command itself failed
          if [ "$response" = "CURL_FAILED" ]; then
            echo "‚ùå ERROR: curl command failed"
            echo "This could be due to network issues or invalid URL"
            exit 3
          fi
          
          # Extract HTTP status code (last 3 characters)
          http_code="${response: -3}"
          response_body="${response%???}"
          
          echo "üìä API Response Code: $http_code"
          echo "üìÑ Response Body: $response_body"
          
          # Check if successful
          if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 201 ]; then
            echo "‚úÖ Pipeline triggered successfully!"
          else
            echo "‚ùå Pipeline failed with code: $http_code"
            exit 1
          fi

      - name: Log completion
        run: |
          echo "üéâ Workflow completed at $(date)"
          echo "üë§ User: ${{ github.event.inputs.userName || 'Scheduled User' }}"
          echo "üìß Email: ${{ github.event.inputs.email || 'N/A' }}"
          echo "üåê Language: ${{ github.event.inputs.language || 'English' }}"
          echo "üì∞ News Type: ${{ github.event.inputs.newsType || 'all' }}"
          echo "üìç Location: ${{ github.event.inputs.location || 'N/A' }}"