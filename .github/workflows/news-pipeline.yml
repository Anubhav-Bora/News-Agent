name: News Pipeline Scheduler

on:
  # Manual trigger with scheduling options
  workflow_dispatch:
    inputs:
      userId:
        description: 'User ID'
        required: true
        type: string
      userName:
        description: 'User Name'
        required: true
        type: string
      email:
        description: 'User Email'
        required: true
        type: string
      language:
        description: 'Preferred Language'
        required: true
        type: choice
        options:
          - 'English'
          - 'Hindi'
        default: 'English'
      newsType:
        description: 'News Category'
        required: true
        type: choice
        options:
          - 'all'
          - 'technology'
          - 'business'
          - 'sports'
          - 'politics'
          - 'entertainment'
          - 'health'
          - 'science'
          - 'state'
        default: 'all'
      state:
        description: 'State (for state news)'
        required: false
        type: string
      location:
        description: 'Location (for weather)'
        required: false
        type: string
      schedule_time:
        description: 'Schedule Time (UTC, format: HH:MM)'
        required: false
        type: string
      schedule_date:
        description: 'Schedule Date (format: YYYY-MM-DD)'
        required: false
        type: string
      run_now:
        description: 'Run immediately'
        required: true
        type: boolean
        default: true

  # User controlled scheduling only - no automatic runs

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Wait for scheduled time
        if: ${{ !github.event.inputs.run_now && github.event.inputs.schedule_time && github.event.inputs.schedule_date }}
        run: |
          TARGET_DATE="${{ github.event.inputs.schedule_date }}"
          TARGET_TIME="${{ github.event.inputs.schedule_time }}"
          TARGET_DATETIME="${TARGET_DATE} ${TARGET_TIME}:00"
          TARGET_TIMESTAMP=$(date -d "$TARGET_DATETIME UTC" +%s)
          CURRENT_TIMESTAMP=$(date +%s)
          
          if [ $TARGET_TIMESTAMP -gt $CURRENT_TIMESTAMP ]; then
            SLEEP_DURATION=$((TARGET_TIMESTAMP - CURRENT_TIMESTAMP))
            echo "Waiting $SLEEP_DURATION seconds until $TARGET_DATETIME UTC"
            sleep $SLEEP_DURATION
          else
            echo "Scheduled time has already passed, running immediately"
          fi

      - name: Set environment variables
        run: |
          echo "NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}" >> $GITHUB_ENV
          echo "SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" >> $GITHUB_ENV
          echo "GOOGLE_GEMINI_API_KEY=${{ secrets.GOOGLE_GEMINI_API_KEY }}" >> $GITHUB_ENV
          echo "SUPABASE_STORAGE_BUCKET=${{ secrets.SUPABASE_STORAGE_BUCKET }}" >> $GITHUB_ENV
          echo "EMAIL_HOST=${{ secrets.EMAIL_HOST }}" >> $GITHUB_ENV
          echo "EMAIL_PORT=${{ secrets.EMAIL_PORT }}" >> $GITHUB_ENV
          echo "EMAIL_USER=${{ secrets.EMAIL_USER }}" >> $GITHUB_ENV
          echo "EMAIL_PASSWORD=${{ secrets.EMAIL_PASSWORD }}" >> $GITHUB_ENV

      - name: Run News Pipeline
        run: |
          echo "Running news pipeline for user: ${{ github.event.inputs.userName || 'Scheduled User' }}"
          
          # Run the pipeline via API call to Vercel deployment
          curl -X POST "${{ secrets.VERCEL_APP_URL }}/api/run-pipeline" \
            -H "Content-Type: application/json" \
            -d '{
              "userId": "${{ github.event.inputs.userId || 'github-scheduled' }}",
              "userName": "${{ github.event.inputs.userName || 'Scheduled User' }}",
              "email": "${{ github.event.inputs.email }}",
              "language": "${{ github.event.inputs.language || 'English' }}",
              "newsType": "${{ github.event.inputs.newsType || 'all' }}",
              "state": "${{ github.event.inputs.state }}",
              "location": "${{ github.event.inputs.location }}",
              "source": "github-workflow"
            }'

      - name: Log completion
        run: |
          echo "Pipeline completed at $(date)"
          echo "User: ${{ github.event.inputs.userName || 'Scheduled User' }}"
          echo "Email: ${{ github.event.inputs.email }}"
          echo "Language: ${{ github.event.inputs.language || 'English' }}"
          echo "News Type: ${{ github.event.inputs.newsType || 'all' }}"